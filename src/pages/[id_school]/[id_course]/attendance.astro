---
import CourseLayout from "../../../layouts/CourseLayout.astro";
import { db, eq, and, Attendance as AttendanceModel } from "astro:db";
import { getCourseData } from "../../../lib/courseUtils";

export const prerender = false;

const { id_school, id_course } = Astro.params;

if (!id_school || !id_course) {
  return new Response("Parámetros inválidos", {
    status: 400,
    statusText: "Bad Request",
  });
}

const result = await getCourseData(Astro.request, id_school, id_course);

if (result.error) {
  return new Response(result.error, {
    status: result.status,
    statusText: result.statusText,
  });
}

const { school, course, userId } = result;

const attendanceData = await db
  .select()
  .from(AttendanceModel)
  .where(
    and(
      eq(AttendanceModel.course_id, id_course),
      eq(AttendanceModel.user_id, userId),
    ),
  );
---

<CourseLayout school={school} course={course} activeTab="attendance">
  <div>
    <h2 class="text-2xl font-semibold mb-4 dark:text-white">Asistencias</h2>
    {
      attendanceData.length === 0 ? (
        <p class="text-gray-400">
          No hay asistencias registradas para este curso.
        </p>
      ) : (
        <ul class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {attendanceData.map((att) => (
            <a href={`/${school.id}/${course.id}/exams`} class="h-full w-full">
              <li class="flex justify-center items-center dark:text-white rounded-md bg-zinc-700 p-2 select-none hover:bg-white hover:text-zinc-700 transition-all">
                {new Date(att.attendance_date).toLocaleDateString()}
              </li>
            </a>
          ))}
          <li>
            <a class="bg-orange-600 hover:bg-orange-700 text-zinc-900 font-semibold flex justify-center items-center rounded-lg w-full h-full transition-all">
              <svg
                class="stroke-2 stroke-white w-6 h-6"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M7 12h5m0 0h5m-5 0V7m0 5v5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </a>
          </li>
        </ul>
      )
    }
  </div>
</CourseLayout>
