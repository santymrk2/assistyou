---
import Layout from "../../layouts/Layout.astro";
import { generateId } from "../../lib/utils";
import { getSession } from "auth-astro/server";
import { db, eq, and, School, Course } from "astro:db";

export const prerender = false;

const { id_school } = Astro.params;

const session = await getSession(Astro.request);
if (!session) {
  return new Response("No hay sesión activa", {
    status: 401,
    statusText: "Unauthorized",
  });
}

const userId = session.user.email ? generateId(session.user.email) : "";

// Validar que el ID existe
if (!id_school || typeof id_school !== "string") {
  return new Response("ID de escuela inválido", {
    status: 400,
    statusText: 'Bad Request'
  });
}

// Obtener datos
const [school, courses] = await Promise.all([
  db.select().from(School).where(and(eq(School.id, id_school), eq(School.user_id, userId))).then(res => res[0]),
  db.select().from(Course).where(and(eq(Course.school_id, id_school),eq(School.user_id, userId)))
]);

if (!school) {
  return new Response("Escuela no encontrada", {
    status: 404,
    statusText: 'Not Found'
  });
}
---

<Layout>
  <section class="p-4 w-full">
    <div class="mb-6">
      <a href="/" class="text-orange-600 ">
        &larr; Volver a página principal
      </a>
    </div>
    
    <h1 class="text-3xl font-bold mb-2 dark:text-white">{school.name}</h1>
    <h2 class="text-2xl font-semibold mb-4 dark:text-white">Cursos</h2>
    
    {courses.length === 0 ? (
      <p class="text-white">No hay cursos registrados en esta escuela.</p>
    ) : (
      <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {courses.map((course) => (
          <li class="bg-orange-600 hover:bg-orange-700 rounded-lg shadow transition-colors">
            <a 
              href={`/schools/${school.id}/courses/${course.id}`} 
              class="block"
            >
              <div transition:persist id={`course-` + course.name } class="flex items-center justify-center font-black text-2xl text-white p-4 rounded-xl text-center">
                {course.name}
              </div>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>