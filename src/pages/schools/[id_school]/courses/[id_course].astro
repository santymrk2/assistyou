---
import Layout from "../../../../layouts/Layout.astro";
import { db, eq, School, Course, Student } from "astro:db";

export const prerender = false;

const { id_school, id_course } = Astro.params;

// Validar parámetros
if (!id_school || !id_course) {
  return new Response("Parámetros inválidos", {
    status: 400,
    statusText: 'Bad Request'
  });
}

// Obtener datos
const [school, course] = await Promise.all([
  db.select().from(School).where(eq(School.id, id_school)).then(res => res[0]),
  db.select().from(Course).where(eq(Course.id, id_course)).then(res => res[0])
]);

// Validar existencia
if (!school || !course) {
  return new Response("Recurso no encontrado", {
    status: 404,
    statusText: 'Not Found'
  });
}

// Verificar que el curso pertenece a la escuela
if (course.school_course !== school.id) {
  return new Response("El curso no pertenece a esta escuela", {
    status: 400,
    statusText: 'Bad Request'
  });
}

const students = await db
  .select()
  .from(Student)
  .where(eq(Student.course_student, course.id));
---

<Layout>
  <section class="p-4">
    <div class="mb-6">
      <a 
        href={`/schools/${school.id}`} 
        class="text-orange-600 hover:underline"
      >
        &larr; Volver a {school.name}
      </a>
    </div>

    <h1 class="text-3xl font-bold mb-2 dark:text-white">{course.name}</h1>
    <h2 class="text-2xl font-semibold mb-4 dark:text-white">Estudiantes</h2>

    {students.length === 0 ? (
      <p class="text-gray-400">No hay estudiantes registrados en este curso.</p>
    ) : (
      <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {students.map((student) => (
          <li class="bg-gray-100 rounded-lg shadow flex items-center justify-between group hover:bg-gray-200 transition-colors">
            <div class="font-semibold text-lg p-5">
              {student.name}
            </div>
          </li>
        ))}
      </ul>
    )}

    <div class="mt-8">
      <h2 class="text-2xl font-semibold mb-4 dark:text-white">Asistencias</h2>
      <p class="text-gray-500">No hay asistencias registradas para este curso.</p>
      <button class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-lg mt-4">
        Agregar asistencia
      </button>
    </div>
  </section>
</Layout>

<script>

</script>